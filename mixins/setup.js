import global from "~/mixins/global.js";

const sleep = (milliseconds) => {
    return new Promise(resolve => setTimeout(resolve, milliseconds))
}

export default {
    mixins: [global],
    methods: {
        deleteWorkerConfirmBox() {
            this.$bvModal.msgBoxConfirm('Are you sure? Have you withdrawn all remaining dust from the contract?')
                .then(value => {
                    if (value) {
                        var addressKey = `workerAddress${this.$store.state.myAccount.networkId}`;
                        localStorage.removeItem(addressKey);
                        window.location.reload();                  
                    }
                })
                .catch(err => {
                console.log(err);
                })
        },
        async deployWorker() {
            this.showOverlay = true; 

            var workerContract = new window.w3.eth.Contract([{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"_from","type":"address"},{"indexed":true,"internalType":"address","name":"_assetAddress","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"LogWithdraw","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"_from","type":"address"},{"indexed":true,"internalType":"address","name":"_assetAddress","type":"address"},{"indexed":false,"internalType":"uint256","name":"id","type":"uint256"}],"name":"LogWithdrawNFT","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"previousOwner","type":"address"},{"indexed":true,"internalType":"address","name":"newOwner","type":"address"}],"name":"OwnershipTransferred","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"address","name":"account","type":"address"}],"name":"Paused","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"address","name":"account","type":"address"}],"name":"Unpaused","type":"event"},{"inputs":[{"components":[{"internalType":"address","name":"To","type":"address"},{"internalType":"bytes","name":"Data","type":"bytes"}],"internalType":"struct Worker.Action[]","name":"actions","type":"tuple[]"}],"name":"execute","outputs":[{"components":[{"internalType":"bool","name":"status","type":"bool"},{"internalType":"bytes","name":"Data","type":"bytes"}],"internalType":"struct Worker.Result[]","name":"","type":"tuple[]"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"},{"internalType":"address","name":"","type":"address"},{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"bytes","name":"","type":"bytes"}],"name":"onERC721Received","outputs":[{"internalType":"bytes4","name":"","type":"bytes4"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"paused","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"renounceOwnership","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"newOwner","type":"address"}],"name":"transferOwnership","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"sender","type":"address"},{"internalType":"uint256","name":"_amount0","type":"uint256"},{"internalType":"uint256","name":"_amount1","type":"uint256"},{"internalType":"bytes","name":"_data","type":"bytes"}],"name":"uniswapV2Call","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"_assetAddress","type":"address"}],"name":"withdraw","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"_assetAddress","type":"address"},{"internalType":"uint256","name":"_assetID","type":"uint256"}],"name":"withdrawERC721","outputs":[],"stateMutability":"nonpayable","type":"function"}]);
            var worker = workerContract.deploy({
                data: '0x608060405234801561001057600080fd5b5061002d61002261004c60201b60201c565b61005460201b60201c565b60008060146101000a81548160ff021916908315150217905550610118565b600033905090565b60008060009054906101000a900473ffffffffffffffffffffffffffffffffffffffff169050816000806101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055508173ffffffffffffffffffffffffffffffffffffffff168173ffffffffffffffffffffffffffffffffffffffff167f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e060405160405180910390a35050565b611eb3806101276000396000f3fe608060405234801561001057600080fd5b50600436106100935760003560e01c8063715018a611610066578063715018a61461011e5780638da5cb5b14610128578063baae8abf14610146578063f2fde38b14610176578063f3e414f81461019257610093565b806310d1e85c14610098578063150b7a02146100b457806351cff8d9146100e45780635c975abb14610100575b600080fd5b6100b260048036038101906100ad9190611191565b6101ae565b005b6100ce60048036038101906100c9919061135a565b6105fc565b6040516100db9190611418565b60405180910390f35b6100fe60048036038101906100f99190611433565b610610565b005b610108610892565b604051610115919061147b565b60405180910390f35b6101266108a8565b005b610130610930565b60405161013d91906114a5565b60405180910390f35b610160600480360381019061015b9190611617565b610959565b60405161016d91906117f6565b60405180910390f35b610190600480360381019061018b9190611433565b610b93565b005b6101ac60048036038101906101a79190611818565b610c8a565b005b6101b6610892565b156101f6576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016101ed906118b5565b60405180910390fd5b60003373ffffffffffffffffffffffffffffffffffffffff16630dfe16816040518163ffffffff1660e01b8152600401602060405180830381865afa158015610243573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061026791906118ea565b905060003373ffffffffffffffffffffffffffffffffffffffff1663d21220a76040518163ffffffff1660e01b8152600401602060405180830381865afa1580156102b6573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906102da91906118ea565b9050600084848101906102ed91906119ab565b9050806000015173ffffffffffffffffffffffffffffffffffffffff1663c45a01556040518163ffffffff1660e01b8152600401602060405180830381865afa15801561033e573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061036291906118ea565b73ffffffffffffffffffffffffffffffffffffffff1663e6a4390584846040518363ffffffff1660e01b815260040161039c9291906119f4565b602060405180830381865afa1580156103b9573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906103dd91906118ea565b73ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff161461044a576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161044190611a69565b60405180910390fd5b60008714806104595750600086145b610498576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161048f90611ad5565b60405180910390fd5b6000871415806104a9575060008614155b6104e8576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016104df90611b41565b60405180910390fd5b6104f0610930565b73ffffffffffffffffffffffffffffffffffffffff168873ffffffffffffffffffffffffffffffffffffffff161461055d576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161055490611a69565b60405180910390fd5b61056a8160600151610dde565b50806020015173ffffffffffffffffffffffffffffffffffffffff1663a9059cbb3383604001516040518363ffffffff1660e01b81526004016105ae929190611b70565b6020604051808303816000875af11580156105cd573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906105f19190611bc5565b505050505050505050565b600063150b7a0260e01b9050949350505050565b610618610f9c565b73ffffffffffffffffffffffffffffffffffffffff16610636610930565b73ffffffffffffffffffffffffffffffffffffffff161461068c576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161068390611c3e565b60405180910390fd5b60008073ffffffffffffffffffffffffffffffffffffffff168273ffffffffffffffffffffffffffffffffffffffff160361072d5760003090508073ffffffffffffffffffffffffffffffffffffffff163191503373ffffffffffffffffffffffffffffffffffffffff166108fc839081150290604051600060405180830381858888f19350505050158015610726573d6000803e3d6000fd5b5050610829565b8173ffffffffffffffffffffffffffffffffffffffff166370a08231306040518263ffffffff1660e01b815260040161076691906114a5565b602060405180830381865afa158015610783573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906107a79190611c73565b90508173ffffffffffffffffffffffffffffffffffffffff1663a9059cbb33836040518363ffffffff1660e01b81526004016107e4929190611b70565b6020604051808303816000875af1158015610803573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906108279190611bc5565b505b8173ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff167f9207361cc2a04b9c7a06691df1eb87c6a63957ae88bf01d0d18c81e3d1272099836040516108869190611ca0565b60405180910390a35050565b60008060149054906101000a900460ff16905090565b6108b0610f9c565b73ffffffffffffffffffffffffffffffffffffffff166108ce610930565b73ffffffffffffffffffffffffffffffffffffffff1614610924576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161091b90611c3e565b60405180910390fd5b61092e6000610fa4565b565b60008060009054906101000a900473ffffffffffffffffffffffffffffffffffffffff16905090565b6060610963610f9c565b73ffffffffffffffffffffffffffffffffffffffff16610981610930565b73ffffffffffffffffffffffffffffffffffffffff16146109d7576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016109ce90611c3e565b60405180910390fd5b6109df610892565b15610a1f576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610a16906118b5565b60405180910390fd5b6000825167ffffffffffffffff811115610a3c57610a3b61122f565b5b604051908082528060200260200182016040528015610a7557816020015b610a62611068565b815260200190600190039081610a5a5790505b50905060005b8351811015610b8957600080858381518110610a9a57610a99611cbb565b5b60200260200101516000015173ffffffffffffffffffffffffffffffffffffffff16868481518110610acf57610ace611cbb565b5b602002602001015160200151604051610ae89190611d26565b6000604051808303816000865af19150503d8060008114610b25576040519150601f19603f3d011682016040523d82523d6000602084013e610b2a565b606091505b509150915081610b3957600080fd5b60006040518060400160405280841515815260200183815250905080858581518110610b6857610b67611cbb565b5b60200260200101819052505050508080610b8190611d6c565b915050610a7b565b5080915050919050565b610b9b610f9c565b73ffffffffffffffffffffffffffffffffffffffff16610bb9610930565b73ffffffffffffffffffffffffffffffffffffffff1614610c0f576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610c0690611c3e565b60405180910390fd5b600073ffffffffffffffffffffffffffffffffffffffff168173ffffffffffffffffffffffffffffffffffffffff1603610c7e576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610c7590611e26565b60405180910390fd5b610c8781610fa4565b50565b610c92610f9c565b73ffffffffffffffffffffffffffffffffffffffff16610cb0610930565b73ffffffffffffffffffffffffffffffffffffffff1614610d06576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610cfd90611c3e565b60405180910390fd5b8173ffffffffffffffffffffffffffffffffffffffff166342842e0e3033846040518463ffffffff1660e01b8152600401610d4393929190611e46565b600060405180830381600087803b158015610d5d57600080fd5b505af1158015610d71573d6000803e3d6000fd5b505050508173ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff167f9207361cc2a04b9c7a06691df1eb87c6a63957ae88bf01d0d18c81e3d127209983604051610dd29190611ca0565b60405180910390a35050565b6060610de8610892565b15610e28576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610e1f906118b5565b60405180910390fd5b6000825167ffffffffffffffff811115610e4557610e4461122f565b5b604051908082528060200260200182016040528015610e7e57816020015b610e6b611068565b815260200190600190039081610e635790505b50905060005b8351811015610f9257600080858381518110610ea357610ea2611cbb565b5b60200260200101516000015173ffffffffffffffffffffffffffffffffffffffff16868481518110610ed857610ed7611cbb565b5b602002602001015160200151604051610ef19190611d26565b6000604051808303816000865af19150503d8060008114610f2e576040519150601f19603f3d011682016040523d82523d6000602084013e610f33565b606091505b509150915081610f4257600080fd5b60006040518060400160405280841515815260200183815250905080858581518110610f7157610f70611cbb565b5b60200260200101819052505050508080610f8a90611d6c565b915050610e84565b5080915050919050565b600033905090565b60008060009054906101000a900473ffffffffffffffffffffffffffffffffffffffff169050816000806101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055508173ffffffffffffffffffffffffffffffffffffffff168173ffffffffffffffffffffffffffffffffffffffff167f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e060405160405180910390a35050565b6040518060400160405280600015158152602001606081525090565b6000604051905090565b600080fd5b600080fd5b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b60006110c382611098565b9050919050565b6110d3816110b8565b81146110de57600080fd5b50565b6000813590506110f0816110ca565b92915050565b6000819050919050565b611109816110f6565b811461111457600080fd5b50565b60008135905061112681611100565b92915050565b600080fd5b600080fd5b600080fd5b60008083601f8401126111515761115061112c565b5b8235905067ffffffffffffffff81111561116e5761116d611131565b5b60208301915083600182028301111561118a57611189611136565b5b9250929050565b6000806000806000608086880312156111ad576111ac61108e565b5b60006111bb888289016110e1565b95505060206111cc88828901611117565b94505060406111dd88828901611117565b935050606086013567ffffffffffffffff8111156111fe576111fd611093565b5b61120a8882890161113b565b92509250509295509295909350565b600080fd5b6000601f19601f8301169050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b6112678261121e565b810181811067ffffffffffffffff821117156112865761128561122f565b5b80604052505050565b6000611299611084565b90506112a5828261125e565b919050565b600067ffffffffffffffff8211156112c5576112c461122f565b5b6112ce8261121e565b9050602081019050919050565b82818337600083830152505050565b60006112fd6112f8846112aa565b61128f565b90508281526020810184848401111561131957611318611219565b5b6113248482856112db565b509392505050565b600082601f8301126113415761134061112c565b5b81356113518482602086016112ea565b91505092915050565b600080600080608085870312156113745761137361108e565b5b6000611382878288016110e1565b9450506020611393878288016110e1565b93505060406113a487828801611117565b925050606085013567ffffffffffffffff8111156113c5576113c4611093565b5b6113d18782880161132c565b91505092959194509250565b60007fffffffff0000000000000000000000000000000000000000000000000000000082169050919050565b611412816113dd565b82525050565b600060208201905061142d6000830184611409565b92915050565b6000602082840312156114495761144861108e565b5b6000611457848285016110e1565b91505092915050565b60008115159050919050565b61147581611460565b82525050565b6000602082019050611490600083018461146c565b92915050565b61149f816110b8565b82525050565b60006020820190506114ba6000830184611496565b92915050565b600067ffffffffffffffff8211156114db576114da61122f565b5b602082029050602081019050919050565b600080fd5b600080fd5b60006040828403121561150c5761150b6114ec565b5b611516604061128f565b90506000611526848285016110e1565b600083015250602082013567ffffffffffffffff81111561154a576115496114f1565b5b6115568482850161132c565b60208301525092915050565b6000611575611570846114c0565b61128f565b9050808382526020820190506020840283018581111561159857611597611136565b5b835b818110156115df57803567ffffffffffffffff8111156115bd576115bc61112c565b5b8086016115ca89826114f6565b8552602085019450505060208101905061159a565b5050509392505050565b600082601f8301126115fe576115fd61112c565b5b813561160e848260208601611562565b91505092915050565b60006020828403121561162d5761162c61108e565b5b600082013567ffffffffffffffff81111561164b5761164a611093565b5b611657848285016115e9565b91505092915050565b600081519050919050565b600082825260208201905092915050565b6000819050602082019050919050565b61169581611460565b82525050565b600081519050919050565b600082825260208201905092915050565b60005b838110156116d55780820151818401526020810190506116ba565b838111156116e4576000848401525b50505050565b60006116f58261169b565b6116ff81856116a6565b935061170f8185602086016116b7565b6117188161121e565b840191505092915050565b600060408301600083015161173b600086018261168c565b506020830151848203602086015261175382826116ea565b9150508091505092915050565b600061176c8383611723565b905092915050565b6000602082019050919050565b600061178c82611660565b611796818561166b565b9350836020820285016117a88561167c565b8060005b858110156117e457848403895281516117c58582611760565b94506117d083611774565b925060208a019950506001810190506117ac565b50829750879550505050505092915050565b600060208201905081810360008301526118108184611781565b905092915050565b6000806040838503121561182f5761182e61108e565b5b600061183d858286016110e1565b925050602061184e85828601611117565b9150509250929050565b600082825260208201905092915050565b7f5061757361626c653a2070617573656400000000000000000000000000000000600082015250565b600061189f601083611858565b91506118aa82611869565b602082019050919050565b600060208201905081810360008301526118ce81611892565b9050919050565b6000815190506118e4816110ca565b92915050565b600060208284031215611900576118ff61108e565b5b600061190e848285016118d5565b91505092915050565b60006080828403121561192d5761192c6114ec565b5b611937608061128f565b90506000611947848285016110e1565b600083015250602061195b848285016110e1565b602083015250604061196f84828501611117565b604083015250606082013567ffffffffffffffff811115611993576119926114f1565b5b61199f848285016115e9565b60608301525092915050565b6000602082840312156119c1576119c061108e565b5b600082013567ffffffffffffffff8111156119df576119de611093565b5b6119eb84828501611917565b91505092915050565b6000604082019050611a096000830185611496565b611a166020830184611496565b9392505050565b7f556e617574686f72697a65640000000000000000000000000000000000000000600082015250565b6000611a53600c83611858565b9150611a5e82611a1d565b602082019050919050565b60006020820190508181036000830152611a8281611a46565b9050919050565b7f5468657265206d7573742062652061207a65726f206173736574000000000000600082015250565b6000611abf601a83611858565b9150611aca82611a89565b602082019050919050565b60006020820190508181036000830152611aee81611ab2565b9050919050565b7f5468657265206d7573742062652061206e6f6e207a65726f2061737365740000600082015250565b6000611b2b601e83611858565b9150611b3682611af5565b602082019050919050565b60006020820190508181036000830152611b5a81611b1e565b9050919050565b611b6a816110f6565b82525050565b6000604082019050611b856000830185611496565b611b926020830184611b61565b9392505050565b611ba281611460565b8114611bad57600080fd5b50565b600081519050611bbf81611b99565b92915050565b600060208284031215611bdb57611bda61108e565b5b6000611be984828501611bb0565b91505092915050565b7f4f776e61626c653a2063616c6c6572206973206e6f7420746865206f776e6572600082015250565b6000611c28602083611858565b9150611c3382611bf2565b602082019050919050565b60006020820190508181036000830152611c5781611c1b565b9050919050565b600081519050611c6d81611100565b92915050565b600060208284031215611c8957611c8861108e565b5b6000611c9784828501611c5e565b91505092915050565b6000602082019050611cb56000830184611b61565b92915050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b600081905092915050565b6000611d008261169b565b611d0a8185611cea565b9350611d1a8185602086016116b7565b80840191505092915050565b6000611d328284611cf5565b915081905092915050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b6000611d77826110f6565b91507fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff8203611da957611da8611d3d565b5b600182019050919050565b7f4f776e61626c653a206e6577206f776e657220697320746865207a65726f206160008201527f6464726573730000000000000000000000000000000000000000000000000000602082015250565b6000611e10602683611858565b9150611e1b82611db4565b604082019050919050565b60006020820190508181036000830152611e3f81611e03565b9050919050565b6000606082019050611e5b6000830186611496565b611e686020830185611496565b611e756040830184611b61565b94935050505056fea26469706673582212201d93d1b121bfad65dbc662647caffb187b9b39a58a7d88de734a0fa4b17aa9a864736f6c634300080d0033', 
                arguments: [
                ]
            }).send({
                from: this.coinbase,
                gasPrice: this.gas_price, 
                gas: '1999999'
            }, async (e, transactionHash) => {
                console.log(e, transactionHash);
                let transactionReceipt = null
                while (transactionReceipt == null) {
                    transactionReceipt = await new window.w3.eth.getTransactionReceipt(transactionHash);
                    await sleep(2500);
                }
                console.log(transactionReceipt);
                var addressKey =  `workerAddress${this.$store.state.myAccount.networkId}`;
                localStorage.setItem(addressKey, transactionReceipt.contractAddress);

                this.$store.commit('myAccount/change', {
                    networkId: this.networkId,
                    coinbase: this.coinbase,
                    balance: this.humanize(await window.w3.eth.getBalance(this.coinbase), 18), 
                });

                this.showOverlay = false;
            });
        }
    }
}